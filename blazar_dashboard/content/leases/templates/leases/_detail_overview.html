{% load i18n sizeformat %}

<div class="detail">
  <div class="info detail">
    <h4>{% trans "Lease" %}</h4>
    <hr class="header_rule">
    <dl class="dl-horizontal">
      <dt>{% trans "Name" %}</dt>
      <dd>{{ lease.name|default:_("None") }}</dd>
      <dt>{% trans "Id" %}</dt>
      <dd>{{ lease.id|default:_("None") }}</dd>
      <dt>{% trans "Project Id" %}</dt>
      <dd>{{ lease.project_id|default:_("None") }}</dd>
      <dt>{% trans "Start date" %}</dt>
      <dd>{{ lease.start_date|parse_isotime|date:"Y-m-d H:i T"|default:"-" }}</dd>
      <dt>{% trans "End date" %}</dt>
      <dd>{{ lease.end_date|parse_isotime|date:"Y-m-d H:i T"|default:"-" }}</dd>
      <dt>{% trans "Status" %}</dt>
      <dd>{{ lease.status|default:"-" }}</dd>
      <dt>{% trans "Degraded" %}</dt>
      <dd>{{ lease.degraded|yesno|capfirst|default:"-" }}</dd>
    </dl>
  </div>

  <div class="info detail">
    <h4>{% trans "Events" %}</h4>
    <hr class="header_rule">
    <dl class="dl-horizontal">
    {% for event in lease.events %}
      <dt>{{ event.event_type }}</dt>
      <dd>
        <ul>
          <li><em>{% trans "Status:" %}</em>&nbsp;{{ event.status|replace_underscores|lower|capfirst }}</li>
          <li><em>{% trans "Time:" %}</em>&nbsp;{{ event.time|parse_isotime|date:"Y-m-d H:i T"|default:"-" }}</li>
        </ul>
      </dd>
      {% empty %}
      <dt>{% trans "No events defined." %}</dt>
    {% endfor %}
    </dl>
  </div>

  <div class="info detail">
    <h4>{% trans "Reservations" %}</h4>
    {% for reservation in lease.reservations %}
      <hr class="header_rule">
      <dl class="dl-horizontal">
        <dt>{% trans "id" %}</dt>
        <dd>{{ reservation.id|default:"-" }}</dd>
        <dt>{% trans "status" %}</dt>
        <dd>{{ reservation.status|default:"-" }}</dd>
        <dt>{% trans "resource type" %}</dt>
        <dd>{{ reservation.resource_type|default:"-" }}</dd>
        <dt>{% trans "missing resources" %}</dt>
        <dd>{{ reservation.missing_resources|yesno|capfirst|default:"-" }}</dd>
        <dt>{% trans "resources changed" %}</dt>
        <dd>{{ reservation.resources_changed|yesno|capfirst|default:"-" }}</dd>
        {% for key, value in reservation.items %}
          {% if key not in reservation_generals %}
            <dt>{{ key }}</dt>
            {% if value is True or value is False %}
              <dd>{{ value|yesno|capfirst|default:"-" }}</dd>
            {% else %}
              <dd>{{ value|default:"-" }}</dd>
            {% endif %}
          {% endif %}
        {% endfor %}
      </dl>
    {% endfor %}
  </div>

{% if nodes %}
  <div class="info detail">
    <h4>{% trans "Nodes" %}</h4>
    <hr class="header_rule">
    <form role="form" method="post" action="{% url 'horizon:project:leases:reallocate' lease.id %}">
      {% csrf_token %}
      <dl class="dl-horizontal">
        {% for node in nodes %}
          <dt></dt>
            <dd class="lease-detail-host-container" data-display="{{ node.node_name }}">
              <span class="lease-detail-host-name">
              {% if site %}
                <a href="https://www.chameleoncloud.org/hardware/node/sites/{{ site }}/clusters/chameleon/nodes/{{ node.hypervisor_hostname }}/">
                  {{ node.node_name }} (uid: {{ node.hypervisor_hostname }})
                </a>
              {% else %}
                  {{ node.node_name }} (uid: {{ node.hypervisor_hostname }})
              {% endif %}
              <b>
                (status:
                {% if node.reservable %}
                  healthy)
                {% else %}
                  unhealthy)
                {% endif %}
              </b>
                <button class="btn btn-danger btn-xs"
                        type="submit" name="host_reallocate"
                        help_text="If your node is experiencing issues, please report it to the help desk so it can be fixed."
                        title="Replace this host with another which has the same resource properties."
                        value="{{ node.hypervisor_hostname }} {{ lease.id }}">
                  Re-Allocate Host
                </button>
              </span>
            </dd>
        {% endfor %}
      </dl>
    </form>
  </div>
{% endif %}
</div>
